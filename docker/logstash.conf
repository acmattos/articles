input {
   couchdb_changes {
      db       => "company"
      host     => "couchdb"
      port     => 6984
      secure   => true
      username => "${COUCHDB_USER}"
      password => "${COUCHDB_PASSWORD}"
      ca_file  => "/usr/share/logstash/certs/ca/ca.crt"
      #sequence_path => "/usr/share/logstash/.couchdb_seq_company"
#      sequence_path => "/usr/share/logstash/sequence/.couchdb_seq_pf"
   }
}

filter {
   if [doc][duns] =~ /^.{12,}$/ {
      mutate {
         rename => {
            "[doc][duns]"                                    => "duns"
            "[doc][company_name]"                            => "company"
            "[doc][trade_name]"                              => "trade"
            "[doc][registered_agent_address][street_number]" => "street_number"
            "[doc][registered_agent_address][street_name]"   => "street_name"
            "[doc][registered_agent_address][city]"          => "city"
            "[doc][registered_agent_address][zip_code]"      => "zip_code"
            "[doc][registered_agent_address][state]"         => "state"
         }
         remove_field => [ "[doc]", "[doc_as_upsert]" ]
      }
      if ![company] or ([company] == "") {
         mutate {
            remove_field => [ "company" ]
         }
         mutate {
            add_field => { "company" => "NO_COMPANY" }
         }
      }
      if ![trade] or ([trade] == "") {
         mutate {
            remove_field => [ "trade" ]
         }
         mutate {
            add_field => { "trade" => "NO_TRADE" }
         }
      }
      if [street_name] {
         mutate {
            strip        => [ "street_number", "street_name", "city", "zip_code", "state"]
            add_field    => { "address" => "%{street_number} %{street_name} %{city}, %{state} %{zip_code}" }
            remove_field => [ "street_number", "street_name", "city", "zip_code", "state" ]
         }
      }
   }
}

output {
   elasticsearch {
      hosts                       => ["${ELASTIC_HOSTS}"]
      index                       => "company_idx"
      document_id                 => "%{duns}"
      user                        => "${ELASTIC_USER}"
      password                    => "${ELASTIC_PASSWORD}"
      ssl_enabled                 => true
      ssl_certificate_authorities => ["/usr/share/logstash/certs/ca/ca.crt"]
   }

   stdout { codec => rubydebug }
}



#
#output {
#  if [id] {
#    elasticsearch {
#      hosts => "${ELASTIC_HOST}"
#      index => "company"
#      document_id => "%{id}"
#    }
#  }
#}
#input {
#  couchdb_changes {
#    host => "b-cadastrodb.pgj.rj.gov.br"
#    port => 6984
#    db => "chcpf_bcadastros"
#    username => "${COUCHDB_USER}"
#    password => "${COUCHDB_PASSWORD}"
#    secure => false
#    type => "PF"
#  }
#
#  couchdb_changes {
#    host => "b-cadastrodb.pgj.rj.gov.br"
#    port => 6984
#    db => "chcnpj_bcadastros"
#    username => "${COUCHDB_USER}"
#    password => "${COUCHDB_PASSWORD}"
#    secure => true
#    type => "PJ"
#  }
#
#  #http_poller {
#  #  urls => {
#  #    couchdb_data => {
#  #      method => get
#  #      url => "https://b-cadastrodb.pgj.rj.gov.br:6984/chcpf_bcadastros/_all_docs?include_docs=true"
#  #      headers => {
#  #        Accept => "application/json"
#  #      }
#  #      auth => {
#  #        user => "andre.mattos"
#  #        password => "BfNDPd0KuNfW"
#  #      }
#  #    }
#  #  }
#  #  request_timeout => 60
#  #  schedule => { every => "10s" }  # FrequÃªncia da coleta de dados
#  #  codec => "json"  # Formato dos dados esperados
#  #}
#}
#
#filter {
#  if [type] == "PF" {
#    mutate {
#      rename => {
#        "[doc][cpfId]" => "identificador"
#        "[doc][nomeContribuinte]" => "nome"
#        "[doc][dtNasc]" => "data_nascimento"
#        "[doc][nomeMae]" => "nome_mae"
#      }
#
#      remove_field => [ "[doc]" ]
#    }
#  }
#
#  if [type] == "PJ" {
#    mutate {
#      rename => {
#        "[doc][cnpj]" => "identificador"
#        "[doc][nomeEmpresarial]" => "razao_social"
#        "[doc][nomeFantasia]" => "nome_fantasia"
#        "[doc][tipoLogradouro]" => "tl"
#        "[doc][logradouro]" => "l"
#        "[doc][numero]" => "n"
#        "[doc][complemento]" => "c"
#        "[doc][bairro]" => "b"
#        "[doc][cep]" => "e"
#        "[doc][uf]" => "u"
#      }
#
#      remove_field => [ "[doc]" ]
#    }
#
#    if [tl] {
#      mutate {
#        add_field => { "endereco" => "%{tl} %{l} %{n} %{c} %{b} %{e} %{u}" }
#
#        remove_field => [ "tl",  "l",  "n",  "c",  "b",  "e",  "u" ]
#      }
#    }
#  }
#}
#
#output {
#  if [type] == "PF" {
#    elasticsearch {
#      hosts => "${ELASTIC_HOSTS}"
#      index => "pessoa"
#      document_id => "%{identificador}"
#      user => "${ELASTIC_USER}"
#      password => "${ELASTIC_PASSWORD}"
#      template => "/usr/share/logstash/pessoa-fisica-tpl.json"
#      template_name => "pessoa_fisica_template"
#      template_overwrite => true
#      cacert => "certs/ca/ca.crt"
#    }
#    csv {
#      fields => [ "identificador", "nome", "data_nascimento", "nome_mae"]
#      path => "/usr/share/logstash/ingest_data/output_pf.csv"
#      flush_interval => 10
#    }
#  }
#
#  if [type] == "PJ" and [endereco] {
#    elasticsearch {
#      hosts => "${ELASTIC_HOSTS}"
#      index => "pessoa"
#      document_id => "%{identificador}"
#      user => "${ELASTIC_USER}"
#      password => "${ELASTIC_PASSWORD}"
#      template => "/usr/share/logstash/pessoa-juridica-tpl.json"
#      template_name => "pessoa_juridica_template"
#      template_overwrite => true
#      cacert => "certs/ca/ca.crt"
#    }
#    csv {
#      fields => ["identificador", "razao_social", "nome_fantasia", "endereco"]
#      path => "/usr/share/logstash/ingest_data/output_pj.csv"
#      flush_interval => 10
#    }
#  } else {
#    csv {
#      fields => ["identificador"]
#      path => "/usr/share/logstash/ingest_data/output_erro.csv"
#      flush_interval => 10
#    }
#  }
#
# stdout { codec => rubydebug }
#}
